name: Deploy n8n workflows

on:
  push:
    paths:
      - 'workflows/**'
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy workflows to prod n8n
        env:
          N8N_URL: ${{ secrets.N8N_API_URL }}
          N8N_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          API="$N8N_URL/api/v1"
          AUTH=(-H "X-N8N-API-KEY: $N8N_KEY")
          CT=(-H "Content-Type: application/json")

          # --- Step 1: Ensure all tags exist on prod, build name->id map ---
          echo "=== Syncing tags ==="
          declare -A TAG_MAP

          # Collect all unique tag names from workflow JSONs
          ALL_TAGS=$(jq -r '.tags[]?.name // empty' workflows/*.json | sort -u)

          # Get existing tags from prod
          PROD_TAGS=$(curl -s "${AUTH[@]}" "$API/tags?limit=100")

          for tag_name in $ALL_TAGS; do
            # Check if tag exists on prod
            TAG_ID=$(echo "$PROD_TAGS" | jq -r --arg n "$tag_name" '.data[]? | select(.name == $n) | .id // empty')
            if [ -z "$TAG_ID" ]; then
              # Create tag
              TAG_ID=$(curl -s "${AUTH[@]}" "${CT[@]}" -X POST "$API/tags" \
                -d "{\"name\": \"$tag_name\"}" | jq -r '.id')
              echo "  Created tag: $tag_name ($TAG_ID)"
            else
              echo "  Exists: $tag_name ($TAG_ID)"
            fi
            TAG_MAP[$tag_name]=$TAG_ID
          done

          # --- Step 2: Deploy workflows ---
          echo ""
          echo "=== Deploying workflows ==="

          # Fields accepted by n8n REST API PUT (active and tags are read-only)
          FILTER='{
            name, nodes, connections, staticData,
            settings: (.settings // {} | {
              executionOrder, timezone, callerPolicy, callerIds,
              availableInMCP, saveExecutionProgress, saveManualExecutions,
              saveDataErrorExecution, saveDataSuccessExecution,
              executionTimeout, errorWorkflow, timeSavedPerExecution
            } | with_entries(select(.value != null)))
          }'

          FAILED=0
          for file in workflows/*.json; do
            ID=$(basename "$file" .json)
            NAME=$(jq -r '.name' "$file")
            ACTIVE=$(jq -r '.active' "$file")
            echo "Deploying: $NAME ($ID)..."

            PAYLOAD=$(jq "$FILTER" "$file")

            # Try PUT first (update existing workflow)
            RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X PUT \
              "$API/workflows/$ID" "${AUTH[@]}" "${CT[@]}" -d @-)
            STATUS=$(echo "$RESPONSE" | tail -1)

            if [ "$STATUS" -eq 404 ]; then
              # New workflow â€” POST
              RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X POST \
                "$API/workflows" "${AUTH[@]}" "${CT[@]}" -d @-)
              STATUS=$(echo "$RESPONSE" | tail -1)
              echo "  POST -> HTTP $STATUS"
            else
              echo "  PUT -> HTTP $STATUS"
            fi

            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              BODY=$(echo "$RESPONSE" | sed '$d')
              echo "  FAILED: $BODY"
              FAILED=1
              continue
            fi

            # --- Step 3: Sync tags for this workflow ---
            WORKFLOW_TAGS=$(jq -r '.tags[]?.name // empty' "$file")
            if [ -n "$WORKFLOW_TAGS" ]; then
              TAG_IDS="["
              FIRST=true
              for t in $WORKFLOW_TAGS; do
                TID=${TAG_MAP[$t]}
                if [ -n "$TID" ]; then
                  $FIRST || TAG_IDS+=","
                  TAG_IDS+="{\"id\":\"$TID\"}"
                  FIRST=false
                fi
              done
              TAG_IDS+="]"

              curl -s -o /dev/null -w "" -X PUT "$API/workflows/$ID/tags" \
                "${AUTH[@]}" "${CT[@]}" -d "$TAG_IDS"
              echo "  tags: $WORKFLOW_TAGS"
            fi

            # --- Step 4: Activate if was active locally ---
            if [ "$ACTIVE" = "true" ]; then
              curl -s -o /dev/null -X POST "$API/workflows/$ID/activate" "${AUTH[@]}"
              echo "  activated"
            fi

            echo "  deployed"
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
