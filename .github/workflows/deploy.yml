name: Deploy n8n workflows

on:
  push:
    paths:
      - 'workflows/**'
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy workflows to prod n8n
        env:
          N8N_URL: ${{ secrets.N8N_API_URL }}
          N8N_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          # Strip to API-accepted fields only (active, tags, id are read-only)
          # Settings: strip non-schema fields like binaryMode
          FILTER='{
            name, nodes, connections, staticData,
            settings: (.settings // {} | {
              executionOrder, timezone, callerPolicy, callerIds,
              availableInMCP, saveExecutionProgress, saveManualExecutions,
              saveDataErrorExecution, saveDataSuccessExecution,
              executionTimeout, errorWorkflow, timeSavedPerExecution
            } | with_entries(select(.value != null)))
          }'

          FAILED=0
          for file in workflows/*.json; do
            ID=$(basename "$file" .json)
            echo "Deploying workflow $ID..."

            PAYLOAD=$(jq "$FILTER" "$file")

            # Try PUT first (update existing workflow)
            RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X PUT \
              "$N8N_URL/api/v1/workflows/$ID" \
              -H "X-N8N-API-KEY: $N8N_KEY" \
              -H "Content-Type: application/json" \
              -d @-)
            STATUS=$(echo "$RESPONSE" | tail -1)

            if [ "$STATUS" -eq 404 ]; then
              # Workflow doesn't exist on prod â€” create via POST
              echo "  Not found on prod, creating..."
              RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X POST \
                "$N8N_URL/api/v1/workflows" \
                -H "X-N8N-API-KEY: $N8N_KEY" \
                -H "Content-Type: application/json" \
                -d @-)
              STATUS=$(echo "$RESPONSE" | tail -1)
              echo "  POST -> HTTP $STATUS"
            else
              echo "  PUT -> HTTP $STATUS"
            fi

            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
              echo "  deployed"
            else
              BODY=$(echo "$RESPONSE" | sed '$d')
              echo "  FAILED: $BODY"
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
