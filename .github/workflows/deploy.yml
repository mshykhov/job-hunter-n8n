name: Deploy n8n workflows

on:
  push:
    paths:
      - 'workflows/**'
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy workflows to prod n8n
        env:
          N8N_URL: ${{ secrets.N8N_API_URL }}
          N8N_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          FAILED=0
          for file in workflows/*.json; do
            ID=$(basename "$file" .json)
            echo "Deploying workflow $ID..."

            # Get current prod status to preserve active state
            PROD_ACTIVE=$(curl -s -H "X-N8N-API-KEY: $N8N_KEY" \
              "$N8N_URL/api/v1/workflows/$ID" | jq -r '.active // empty')

            if [ -n "$PROD_ACTIVE" ]; then
              # Workflow exists — preserve prod active status, then PUT
              PAYLOAD=$(jq --argjson active "$PROD_ACTIVE" '.active = $active' "$file")
              STATUS=$(echo "$PAYLOAD" | curl -s -o /dev/null -w "%{http_code}" -X PUT \
                "$N8N_URL/api/v1/workflows/$ID" \
                -H "X-N8N-API-KEY: $N8N_KEY" \
                -H "Content-Type: application/json" \
                -d @-)
              echo "  PUT (active=$PROD_ACTIVE) -> HTTP $STATUS"
            else
              # New workflow — POST
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                "$N8N_URL/api/v1/workflows" \
                -H "X-N8N-API-KEY: $N8N_KEY" \
                -H "Content-Type: application/json" \
                -d @"$file")
              echo "  POST (new) -> HTTP $STATUS"
            fi

            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 300 ]; then
              echo "  deployed"
            else
              echo "  FAILED"
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
