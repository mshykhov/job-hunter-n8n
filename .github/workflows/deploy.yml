name: Deploy n8n workflows

on:
  push:
    paths:
      - 'workflows/**'
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Deploy workflows to prod n8n
        env:
          N8N_URL: ${{ secrets.N8N_API_URL }}
          N8N_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          API="$N8N_URL/api/v1"
          AUTH=(-H "X-N8N-API-KEY: $N8N_KEY")
          CT=(-H "Content-Type: application/json")

          # --- Step 1: Build local-name->prod-id and local-id->prod-id maps ---
          echo "=== Building workflow ID map ==="
          declare -A NAME_TO_PROD_ID
          declare -A LOCAL_TO_PROD_ID

          PROD_WORKFLOWS=$(curl -s "${AUTH[@]}" "$API/workflows?limit=200")
          while IFS='|' read -r PNAME PID; do
            [ -z "$PNAME" ] && continue
            NAME_TO_PROD_ID["$PNAME"]=$PID
          done < <(echo "$PROD_WORKFLOWS" | jq -r '.data[] | "\(.name)|\(.id)"')

          for file in workflows/*.json; do
            LOCAL_ID=$(basename "$file" .json)
            WNAME=$(jq -r '.name' "$file")
            if [ -n "${NAME_TO_PROD_ID[$WNAME]}" ]; then
              LOCAL_TO_PROD_ID[$LOCAL_ID]=${NAME_TO_PROD_ID[$WNAME]}
              echo "  $WNAME: $LOCAL_ID -> ${NAME_TO_PROD_ID[$WNAME]}"
            else
              echo "  $WNAME: new workflow"
            fi
          done

          # --- Step 2: Ensure all tags exist on prod ---
          echo ""
          echo "=== Syncing tags ==="
          declare -A TAG_MAP

          ALL_TAGS=$(jq -r '.tags[]?.name // empty' workflows/*.json | sort -u)
          PROD_TAGS=$(curl -s "${AUTH[@]}" "$API/tags?limit=100")

          for tag_name in $ALL_TAGS; do
            TAG_ID=$(echo "$PROD_TAGS" | jq -r --arg n "$tag_name" \
              '.data[]? | select(.name == $n) | .id // empty')
            if [ -z "$TAG_ID" ]; then
              TAG_ID=$(curl -s "${AUTH[@]}" "${CT[@]}" -X POST "$API/tags" \
                -d "{\"name\": \"$tag_name\"}" | jq -r '.id')
              echo "  Created tag: $tag_name ($TAG_ID)"
            else
              echo "  Exists: $tag_name ($TAG_ID)"
            fi
            TAG_MAP[$tag_name]=$TAG_ID
          done

          # --- Step 3: Deploy workflows ---
          echo ""
          echo "=== Deploying workflows ==="

          # Fields accepted by n8n REST API (active and tags are read-only)
          FILTER='{
            name, nodes, connections, staticData,
            settings: (.settings // {} | {
              executionOrder, timezone, callerPolicy, callerIds,
              availableInMCP, saveExecutionProgress, saveManualExecutions,
              saveDataErrorExecution, saveDataSuccessExecution,
              executionTimeout, errorWorkflow, timeSavedPerExecution
            } | with_entries(select(.value != null)))
          }'

          # Build JSON map for sub-workflow ID remapping (local ID -> prod ID)
          ID_MAP_JSON="{"
          FIRST=true
          for lid in "${!LOCAL_TO_PROD_ID[@]}"; do
            $FIRST || ID_MAP_JSON+=","
            ID_MAP_JSON+="\"$lid\":\"${LOCAL_TO_PROD_ID[$lid]}\""
            FIRST=false
          done
          ID_MAP_JSON+="}"

          FAILED=0
          for file in workflows/*.json; do
            LOCAL_ID=$(basename "$file" .json)
            NAME=$(jq -r '.name' "$file")
            ACTIVE=$(jq -r '.active' "$file")
            PROD_ID=${NAME_TO_PROD_ID[$NAME]:-}

            echo "Deploying: $NAME..."

            # Filter to API-accepted fields and remap sub-workflow IDs
            PAYLOAD=$(jq --argjson idmap "$ID_MAP_JSON" "
              $FILTER |
              .nodes = [.nodes[] | if .parameters.workflowId?.value? then
                .parameters.workflowId.value = (\$idmap[.parameters.workflowId.value] // .parameters.workflowId.value)
              else . end]
            " "$file")

            if [ -n "$PROD_ID" ]; then
              # Update existing workflow
              RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X PUT \
                "$API/workflows/$PROD_ID" "${AUTH[@]}" "${CT[@]}" -d @-)
              STATUS=$(echo "$RESPONSE" | tail -1)
              echo "  PUT $PROD_ID -> HTTP $STATUS"
            else
              # New workflow â€” POST
              RESPONSE=$(echo "$PAYLOAD" | curl -s -w "\n%{http_code}" -X POST \
                "$API/workflows" "${AUTH[@]}" "${CT[@]}" -d @-)
              STATUS=$(echo "$RESPONSE" | tail -1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              PROD_ID=$(echo "$BODY" | jq -r '.id // empty')
              if [ -n "$PROD_ID" ]; then
                NAME_TO_PROD_ID[$NAME]=$PROD_ID
                LOCAL_TO_PROD_ID[$LOCAL_ID]=$PROD_ID
              fi
              echo "  POST -> HTTP $STATUS (id: $PROD_ID)"
            fi

            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              BODY=$(echo "$RESPONSE" | sed '$d')
              echo "  FAILED: $BODY"
              FAILED=1
              continue
            fi

            # --- Sync tags ---
            WORKFLOW_TAGS=$(jq -r '.tags[]?.name // empty' "$file")
            if [ -n "$WORKFLOW_TAGS" ]; then
              TAG_IDS="["
              FIRST=true
              for t in $WORKFLOW_TAGS; do
                TID=${TAG_MAP[$t]}
                if [ -n "$TID" ]; then
                  $FIRST || TAG_IDS+=","
                  TAG_IDS+="{\"id\":\"$TID\"}"
                  FIRST=false
                fi
              done
              TAG_IDS+="]"

              curl -s -o /dev/null -w "" -X PUT "$API/workflows/$PROD_ID/tags" \
                "${AUTH[@]}" "${CT[@]}" -d "$TAG_IDS"
              echo "  tags: $WORKFLOW_TAGS"
            fi

            # --- Activate if was active locally ---
            if [ "$ACTIVE" = "true" ]; then
              curl -s -o /dev/null -X POST "$API/workflows/$PROD_ID/activate" "${AUTH[@]}"
              echo "  activated"
            fi

            echo "  deployed"
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
